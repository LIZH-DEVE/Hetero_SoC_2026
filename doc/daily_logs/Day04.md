# Project Hetero_SoC: Day 4 - The "Shell" Game

> **Date:** 2026-01-24 (Beijing Time)
> **Status:** Bitstream Generated / Hardware Exported (Ready for Software)
> **Author:** Future SoC Architect

## 1. 项目概述 (Overview)

本项目是《异构 SoC (Hetero_SoC)》的第四天里程碑。
**核心目标**：打破 RTL 代码与 EDA 工具之间的“语言隔阂”，完成 DMA 子系统与 Zynq 处理器的物理集成。
**战略意义**：
1.  **架构突围 (Architecture)**：确立了 **Core-Shell (核-壳)** 混合架构，在保留 SystemVerilog 先进特性的同时，完美适配 Vivado Block Design 的遗留标准。
2.  **物理闭环 (Physical Closure)**：修复了复位信号断路风险，打通了 AXI-Full 高速数据通路，并成功生成了最终的比特流 (`.bit`)。

## 2. 开发环境 (Environment)

* **IDE**: Xilinx Vivado 2024.1
* **Device**: Zynq-7000 (XC7Z020)
* **Module**: DMA Subsystem (SystemVerilog Core + Verilog Wrapper)
* **Interface**: AXI4-Full (Master) & AXI4-Lite (Slave)

## 3. 理论军火库 (Knowledge Base)

在 Day 4 中，我们将以下工程哲学转化为落地架构：

### A. 核-壳架构 (Core-Shell Pattern)
* **痛点**：Vivado IP Integrator (Block Design) 对 SystemVerilog 的高级接口（如 `interface`, `modport`）支持存在边界缺陷，直接引用会导致 "Type not allowed" 错误。
* **解法**：构建双层结构。
    * **Core (.sv)**：内核层。使用 SystemVerilog，负责复杂的逻辑实现与状态机流转。
    * **Shell (.v)**：壳层（垫片）。使用 Verilog-2001，作为“物理外交官”，仅包含 `wire` 连线，负责欺骗 EDA 工具进行实例化。
* **效果**：既保留了代码的现代化，又通过了工具的保守审查。

### B. 异构互联拓扑 (Heterogeneous Topology)
* **逻辑**：SoC 系统中存在两种不同速度域的流量。
* **实现**：
    * **控制流 (低速)**：CPU -> `GP Port` -> `AXI-Lite`。像发短信一样配置寄存器。
    * **数据流 (高速)**：DMA -> `HP Port` -> `DDR Memory`。像高速公路一样直接搬运海量数据，不占用 CPU 算力。

## 4. 模块定义与硬件映射 (Specs & Pinout)

### 新增架构层级: `dma_subsystem_wrapper.v`
负责将 SystemVerilog 接口“降维”为标准信号线。

### 互联关系映射 (Interconnect Mapping)
在 Block Design 画布中，我们构建了以下物理连接：

| 信号组 (Interface) | 方向 | 连接对象 (Target) | 物理含义 | Day 4 状态 |
| :--- | :--- | :--- | :--- | :--- |
| `s_axil` | Slave | **Zynq M_AXI_GP0** | 接收 CPU 的控制指令 | ✅ Connected |
| `m_axi` | Master| **Zynq S_AXI_HP0** | 读写 DDR 内存数据 | ✅ Connected |
| `clk` | Input | **FCLK_CLK0** | 系统主时钟 (100MHz?) | ✅ Synced |
| `rst_n` | Input | **peripheral_aresetn** | **系统级低电平复位** | **FIXED** |

> **关键修正**：手动修复了 `rst_n` 的悬空问题，将其挂载到 `rst_ps7_0_100M` 模块，防止 DMA 引擎在上电后处于“植物人”状态。

## 5. 验证与审计 (Verification & Audit)

### 综合与实现 (Synthesis & Impl) - *Passed*
* **IO Placer 修正**：解决了因错误指定顶层 (`dma_subsystem_wrapper`) 导致的引脚布局失败。通过 `Set as Top` 强制指定 `system_wrapper` 为唯一真神。
* **时序收敛**：Implementation 成功完成，未出现 Setup/Hold 违例。

### 交付物 (Deliverables)
1.  **Bitstream**: `system_wrapper.bit` (最终生成的电路配置文件)
2.  **Hardware Platform**: `system_wrapper.xsa` (包含地址映射的硬件描述包)

## 6. 核心认知升级 (Key Learnings)

1.  **不要与工具较劲**：
    * 当工具（Vivado）显示出“老态”时，不要试图强行让它理解先进语法（SV）。用架构手段（Wrapper）去兼容它，是更理性的工程师思维。
2.  **顶层视角的唯一性**：
    * Vivado 的编译器很“笨”，它不知道你想做 SoC 还是做 IP。必须手动通过 `Set as Top` 告诉它谁才是现在的统治者。
3.  **自动化的陷阱**：
    * `Run Connection Automation` 虽然好用，但它经常漏掉复位信号 (`rst_n`)。**人工复核**永远是最后一道防线。

## 7. 顾问评价 (Advisor's Note)

> "Day 4 的价值不在于你连上了几根线，而在于你学会了妥协与控制的平衡。
>
> 你遇到了经典的 EDA 工具‘代沟’问题，但你没有选择为了工具阉割代码（降级回 Verilog），而是选择加了一层 Wrapper 来进行架构隔离。
> 这是一个高级工程师的决策——**保持内核的先进性，同时处理好边界的兼容性**。
>
> 此外，你最后对复位信号的手动修复，避免了 Day 5 调试时的一场灾难。
> 硬件已经就绪，明天，让代码赋予它灵魂。"

---

*Generated by Gemini - Your Brutally Honest Advisor*