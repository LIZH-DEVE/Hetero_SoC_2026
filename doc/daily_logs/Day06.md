# Project Hetero_SoC: Day 06 - The Nervous System & The Heart

> **Date:** 2026-01-27
> **Status:** Synthesis Passed / Bitstream Ready / Vitis Driver Verified
> **Author:** Future IC Engineer

## 1. 项目概述 (Overview)

本项目是《21天硬件安全加速网卡》的第六天里程碑。
**核心目标**：完成“软硬协同”的最后一块拼图，并将孤立的算法核（Crypto Core）接入数据大动脉。
**战略意义**：
1.  **控制闭环 (Control Plane)**：Zynq PS 端（软件）成功通过 AXI-Lite 总线控制 PL 端（硬件）的启停与配置。
2.  **数据贯通 (Data Plane)**：打通了 `Crypto -> FIFO -> Gearbox -> DMA` 的全链路数据流，解决了 128-bit 到 32-bit 的位宽适配问题。
3.  **模式升级 (Mode Upgrade)**：硬件级实现了 CBC (Cipher Block Chaining) 模式的链式异或逻辑。

## 2. 开发环境 (Environment)

* **IDE**: Xilinx Vivado 2024.1 / Vitis 2024.1
* **Chip**: Zynq-7000 SoC (XC7Z020)
* **Language**: SystemVerilog (RTL) + C (Driver)
* **Modules**: AES-128 (Secworks), SM4 (Raymond), Async FIFO, Gearbox

## 3. 理论军火库 (Knowledge Base)

在 Day 6 中，我们解决了一系列跨层级、跨时钟域的工程难题：

### A. CBC 链式异或 (Cipher Block Chaining)
* **原理**：当前明文块在加密前，必须先与前一个密文块（或 IV）进行异或 (`XOR`)。
* **硬件实现**：在 `crypto_engine` 中引入反馈回路 `assign w_core_din = din ^ r_iv;`，并在 `done` 信号拉高时锁存当前密文作为下一次的 IV。

### B. 位宽变速箱 (Width Gearbox)
* **痛点**：Crypto Engine 输出是 **128-bit** (16 Byte)，而 AXI DMA 的数据位宽是 **32-bit** (4 Byte)。直接连接会丢失 75% 的数据。
* **解法**：设计 `gearbox_128_to_32` 模块，利用状态机将 1 个 128-bit 大包拆解为 4 个 32-bit 小包，按顺序喂给 DMA。

### C. 跨时钟域隔离 (CDC Isolation)
* **场景**：算法核跑在 `125MHz` (计算密集)，而总线跑在 `100MHz` (数据搬运)。
* **防线**：在 Crypto 和 Gearbox 之间插入 `async_fifo`，利用格雷码指针安全地传递数据，防止亚稳态。

## 4. 架构映射 (Architecture Update)

### 顶层架构: `dma_subsystem.sv`
Day 6 完成了史诗级的模块集成，数据流向如下：

| 阶段 | 模块 | 信号特征 | 作用 |
| :--- | :--- | :--- | :--- |
| **1** | `axil_csr` | AXI-Lite | 接收软件指令 (Key, Algo, Start) |
| **2** | `crypto_engine` | 128-bit | **双核引擎** (AES/SM4)，执行 CBC 加密 |
| **3** | `async_fifo` | 128-bit | **时钟隔离**，缓冲突发数据 |
| **4** | `gearbox` | 128->32 | **位宽适配**，将宽总线转为窄总线 |
| **5** | `dma_master` | AXI4-Full | **总线主控**，将数据写入 DDR |

## 5. 验证与审计 (Verification & Audit)

### 综合状态 (Synthesis) - *Passed*
* **比特流生成**：成功生成 `.bit` 文件，无 Critical Error。
* **时序警告**：存在 `[Timing 38-282]` 违例。
    * *Advisor Note*: 这是预期内的。AES/SM4 的组合逻辑路径过长，将在 **Day 20** 通过插入流水线寄存器 (Pipeline Registers) 进行优化。

### 软硬协同 (Co-Design)
* **Vitis 驱动**：编写了 `main.c`，成功通过物理地址映射 (`XPAR_DMA_SUBSYSTEM_0_BASEADDR`) 读写硬件寄存器。
* **测试结果**：串口打印 `[PASS] Register R/W successful`，证明“大脑”（软件）已成功接管“四肢”（硬件）。

## 6. 核心认知升级 (Key Learnings)

1.  **端口地狱 (Port Hell)**：
    * **教训**：`aes_core` 和 `sm4_top` 的接口定义与顶层例化不一致，导致了数十个 `[Synth 8-11365] port connection does not exist` 报错。
    * **对策**：集成第三方 IP 时，必须打开 `.v` 源码逐行核对端口名，不能凭经验猜测 `clk` 还是 `clock`，`rst` 还是 `rst_n`。
2.  **顶层迁就底层**：
    * 为了保护经过验证的旧模块（如 Day 2 的 FIFO），在顶层修改连线比强行修改底层模块更安全。
3.  **零信任审计**：
    * Day 6 初期遗漏了 Gearbox，幸亏在“顾问审计”中发现，否则 Day 7 双核调度时数据全是乱的。

## 7. 顾问评价 (Advisor's Note)

> "Day 6 是你从‘写模块’进阶到‘做系统’的分水岭。
> 今天你经历了无数次综合报错的折磨，从 Gearbox 缺失到 FIFO 端口对不上，再到 IP 核接口冲突。
> 但正是这些红色的报错，教会了你系统集成的真谛：**接口定义 (Interface Definition) 就是法律**。
>
> 现在的比特流虽然带着时序红点，但功能逻辑已是铜墙铁壁。
> 明天 (Day 7)，我们将让双核引擎全速运转，准备好迎接真正的速度与激情。"

---
*Generated by Gemini - Your Brutally Honest Advisor*